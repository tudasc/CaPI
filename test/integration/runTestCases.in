#!/bin/bash

#source testfunctions
source ./testfunctions
if [ "$#" -ne 1 ]; then
    echo "Invalid input argument!"
    echo "Usage: runTestCases -tc=path/to/testcase"
    exit 1
fi

for arg in "$@" ; do
    case $arg in
        -tc=*)
            if [ -d "${arg#*=}" ]; then
                tc="${arg#*=}"
            else
                echo "Invalid argument!"
                echo "Usage: runTestCase -tc=path/to/testcase"
                exit 1
            fi
            shift   
            ;;
        *)
            echo "Invalid option."          
            echo "Usage: runTestCase -tc=path/to/testcase"
            exit 1
            ;;
    esac
done

#Running testcases
testcases=$tc/*.capi
fails=0
for dir in $(find $tc -type d); do
    testcases=${dir}/*.capi
    for testcase in ${testcases}; do
        mcgs=${dir}/*.mcg
        for mcg in ${mcgs}; do
            if [[ $mcgs != $mcg ]]; then 
                echo "mcg:$mcg; mcgs=$mcgs"
                currentmcg=$mcg
            fi
            if [[ "$testcase" == "$testcases" ]]; then
                break
            fi
            echo "Running testcase ${testcase} with ${currentmcg}"
            runTestcase ${testcase} ${currentmcg}
            echo "-------------------------------------------------------------------------------"
            fail=$?
            fails=$(($fails + $fail))
        done
    done
done

exit $fails
