#!/bin/bash
#

export OMPI_CXX=@CXX_PATH@

CAPI_LIB_GNU=@CAPI_LIB_DIR@/xray/libcapixray_gnu.a
CAPI_LIB_SCOREP=@CAPI_LIB_DIR@/xray/libcapixray_scorep.a
CAPI_LIB_EXTRAE=@CAPI_LIB_DIR@/xray/libcapixray_extrae.a

LLVM_LIBS=`@LLVM_CONFIG@ --libfiles xray symbolize --link-static --system-libs`

linking=yes
for arg in "$@" ; do
    case "$arg" in
    	-c|-S|-E|-M|-MM|-MMD)
            linking=no
    	    ;;
    esac
done

#Command option
for arg in "$@" ; do
    case $arg in
        --capi-interface=*)
            CAPI_INTERFACE="${arg#*=}"
            shift   
            ;;
        *)
            set -- "$@" "$arg"
            shift
            ;;
    esac
done


#scorep_init.c:
@SCOREP_CONFIG@ --mpp=mpi --nokokkos --noonline-access --adapter-init --compiler > scorep_init.c
#scorep_init.o:
mpic++ -c -x c scorep_init.c

if [[ "$linking" == yes ]] 
then 
    if [[ "$CAPI_INTERFACE" == gnu ]]; then
        echo "gnu"
        mpic++ -Wl,-whole-archive $CAPI_LIB_GNU -Wl,-no-whole-archive -fxray-instrument $LLVM_LIBS $@
    elif [[ "$CAPI_INTERFACE" == scorep ]]; then
        echo "scorep"
        mpic++ scorep_init.o -Wl,-start-group -Wl,-whole-archive $CAPI_LIB_SCOREP -Wl,-no-whole-archive `@SCOREP_CONFIG@ --nokokkos --noonline-access --compiler --ldflags` `@SCOREP_CONFIG@ --libs --mpp=mpi --nokokkos --noonline-access --compiler` -Wl,-end-group -fxray-instrument $LLVM_LIBS $@
    elif [[ "$CAPI_INTERFACE" == extrae ]]; then
        echo "extrae"
        mpic++ -Wl,-whole-archive $CAPI_LIB_EXTRAE -Wl,-no-whole-archive -fxray-instrument $LLVM_LIBS $@
    else
        exit 1
    fi
else
    mpic++ -fxray-instrument -fxray-instruction-threshold=1 $@
fi

